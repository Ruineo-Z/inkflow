# 小说章节生成设计文档

## 概述

小说章节生成是InkFlow的核心功能，负责根据用户的选择动态生成互动式小说内容。系统支持分支剧情，用户的选择将影响故事的发展方向。

## 业务逻辑设计

### 1. 第一章生成流程

当用户完成小说主题选择和初始信息生成后，可触发第一章生成。

#### 输入信息
- 小说世界观设定
- 主角基础信息
- 用户触发生成请求

#### 生成步骤
1. **章节摘要生成**（结构化输出，非流式）
   - 调用AI分析世界观和主角信息
   - 生成第一章的剧情摘要
   - 确定章节主要事件和冲突点

2. **章节正文和选项生成**（结构化流式输出，单次AI调用）
   - 基于章节摘要生成完整的章节正文
   - 同时生成三个选项，每个选项对应不同的剧情发展方向
   - 使用流式输出实时返回内容给用户

#### 输出内容
- 章节标题
- 章节摘要
- 完整章节正文
- 三个剧情选择选项（影响下一章走向）

### 2. 非第一章生成流程

用户选择上一章的选项后触发后续章节生成。

#### 输入信息
- 小说世界观设定
- 主角基础信息
- 当前章节前五章的完整内容（详细剧情）
- 其余章节的摘要信息（概要信息）
- 用户选择的上一章选项

#### 生成步骤
1. **章节摘要生成**（结构化输出，非流式）
   - 分析用户选择的选项及其影响
   - 结合前续章节内容和剧情走向
   - 生成当前章节的剧情摘要

2. **章节正文和选项生成**（结构化流式输出，单次AI调用）
   - 基于章节摘要和历史剧情生成章节正文
   - 考虑用户之前的选择对剧情的影响
   - 生成三个新的选择选项

#### 输出内容
- 章节标题
- 章节摘要
- 完整章节正文
- 三个剧情选择选项

## 技术实现要点

### AI调用策略
- **摘要生成**：使用结构化输出，确保摘要格式标准化
- **正文生成**：使用结构化流式输出，在单次调用中同时生成正文和选项
- **上下文管理**：前五章使用完整内容，其余章节使用摘要，平衡上下文质量和API调用成本

### 数据结构设计
- 章节摘要结构
- 章节正文结构
- 选项结构（包含选项描述和对后续剧情的影响提示）

### 流式输出处理
- 实时返回生成内容
- 支持章节正文的逐步展示
- 在正文生成完成后展示选项

## 用户体验设计

1. **渐进式内容展示**：使用流式输出让用户实时看到章节内容生成
2. **选择驱动剧情**：每个选项都有明确的剧情影响描述
3. **上下文连贯性**：通过前五章详细内容确保剧情连贯
4. **个性化体验**：根据用户历史选择调整剧情发展

## API接口设计概要

### 生成章节接口
- `POST /api/v1/novels/{novel_id}/chapters`
- 支持第一章和后续章节的统一处理
- 返回结构化的章节数据和选项

### 流式输出接口
- 支持Server-Sent Events (SSE)
- 实时返回章节生成进度和内容

## 质量控制

1. **内容一致性**：确保章节内容与世界观和主角设定一致
2. **剧情连贯性**：通过历史章节信息维护故事逻辑
3. **选项多样性**：确保三个选项提供不同的剧情发展路径
4. **长度控制**：控制章节长度在合适范围内

## 扩展性考虑

1. **支持更多选项**：框架设计支持扩展到更多选择分支
2. **章节模板**：支持不同类型小说的章节生成模板
3. **个性化调整**：根据用户偏好调整生成策略